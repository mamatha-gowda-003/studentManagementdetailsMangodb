<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Student</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6fa;
            padding: 40px;
            display: flex;
            justify-content: center;
        }
        .form-box {
            width: 400px;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        input {
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        button {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            border: none;
            border-radius: 6px;
            background: #5b67f1;
            color: white;
            font-size: 15px;
            cursor: pointer;
        }
        .update-by-age-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 6px;
        }
        a {
            display: block;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>

<body>

<div class="form-box">
    <h2>Edit Student</h2>

    <input id="name" placeholder="Enter name" />
    <input id="age" type="number" placeholder="Enter age" />

    <button onclick="updateStudent()">Update Student</button>
    
    <div class="update-by-age-section">
        <h3>Update by Age</h3>
        <input id="ageFilter" type="number" placeholder="Enter age to filter students" />
        <button onclick="filterStudentsByAge()">Find Students with this Age</button>
        <select id="studentSelect" style="display:none; width:100%; margin-top:10px; padding:12px;">
            <option value="">Select a student</option>
        </select>
        <input id="newName" placeholder="Enter new name" style="display:none; margin-top:10px;" />
        <button id="updateByNameBtn" onclick="updateStudentByName()" style="display:none;">Update Name</button>
    </div>
    
    <a href="index.html">Cancel</a>
</div>

<script>
    const API_URL = "http://localhost:5000";

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");

    async function loadStudent() {
        const res = await fetch(`${API_URL}/students/${id}`);
        const stu = await res.json();
        
        document.getElementById("name").value = stu.name;
        document.getElementById("age").value = stu.age;
    }

    async function updateStudent() {
        const name = document.getElementById("name").value;
        const age = document.getElementById("age").value;

        await fetch(`${API_URL}/students/update/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, age })
        });

        window.location.href = "index.html";
    }
    
    async function filterStudentsByAge() {
        const ageFilter = document.getElementById("ageFilter").value;
        if (!ageFilter) {
            alert("Please enter an age to filter");
            return;
        }
        
        const res = await fetch(`${API_URL}/students`);
        const students = await res.json();
        
        const filteredStudents = students.filter(student => student.age == ageFilter);
        
        const select = document.getElementById("studentSelect");
        const newNameInput = document.getElementById("newName");
        const updateBtn = document.getElementById("updateByNameBtn");
        
        if (filteredStudents.length > 0) {
            // Clear previous options
            select.innerHTML = '<option value="">Select a student</option>';
            
            // Add filtered students to dropdown
            filteredStudents.forEach(student => {
                const option = document.createElement("option");
                option.value = student._id;
                option.textContent = `${student.name} (ID: ${student._id})`;
                select.appendChild(option);
            });
            
            // Show the elements
            select.style.display = "block";
            newNameInput.style.display = "block";
            updateBtn.style.display = "block";
        } else {
            alert("No students found with this age");
            select.style.display = "none";
            newNameInput.style.display = "none";
            updateBtn.style.display = "none";
        }
    }
    
    async function updateStudentByName() {
        const selectedStudentId = document.getElementById("studentSelect").value;
        const newName = document.getElementById("newName").value;
        
        if (!selectedStudentId) {
            alert("Please select a student");
            return;
        }
        
        if (!newName) {
            alert("Please enter a new name");
            return;
        }
        
        const ageFilter = document.getElementById("ageFilter").value;
        
        await fetch(`${API_URL}/students/update/${selectedStudentId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: newName, age: parseInt(ageFilter) })
        });
        
        alert("Student name updated successfully!");
        document.getElementById("studentSelect").style.display = "none";
        document.getElementById("newName").style.display = "none";
        document.getElementById("updateByNameBtn").style.display = "none";
        document.getElementById("studentSelect").innerHTML = '<option value="">Select a student</option>';
        document.getElementById("newName").value = "";
    }

    loadStudent();
</script>

</body>
</html>